<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processos - JurisFlow</title>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/pages.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .process-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .process-header {
            background: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .process-title {
            font-size: 2rem;
            font-weight: 700;
            color: #e2e8f0;
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .process-title i {
            color: #fbbf24;
        }

        .process-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .process-content {
            background: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .process-list {
            margin-top: 2rem;
        }

        .data-table-container {
            overflow-x: auto;
            border-radius: 0.75rem;
            border: 1px solid rgba(51, 65, 85, 0.3);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .data-table thead {
            background: rgba(30, 41, 59, 0.8);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #e2e8f0;
            border-bottom: 2px solid rgba(51, 65, 85, 0.5);
        }

        .data-table td {
            padding: 1rem;
            color: #cbd5e1;
            border-bottom: 1px solid rgba(51, 65, 85, 0.2);
        }

        .data-table tbody tr {
            transition: background 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(51, 65, 85, 0.2);
        }

        .status-loading {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .status-loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #60a5fa;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .search-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 0.875rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(51, 65, 85, 0.5);
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            font-size: 0.95rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .col-date {
            color: #fbbf24;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* Details Modal Styles */
        .details-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title i {
            color: #fbbf24;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .detail-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .detail-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .detail-card-header {
            background: rgba(51, 65, 85, 0.4);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
        }

        .detail-card-number {
            font-weight: 700;
            color: #60a5fa;
            font-size: 0.875rem;
        }

        .detail-card-id {
            font-family: monospace;
            font-size: 0.75rem;
            color: #94a3b8;
            background: rgba(15, 23, 42, 0.8);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .detail-card-body {
            padding: 1.25rem;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 1rem;
            margin-bottom: 0.875rem;
            align-items: start;
        }

        .detail-row-full {
            grid-template-columns: 1fr;
        }

        .detail-label {
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .detail-value {
            color: #e2e8f0;
            font-size: 0.95rem;
            word-break: break-word;
        }

        .detail-content {
            background: rgba(15, 23, 42, 0.8);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(51, 65, 85, 0.3);
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .detail-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

</head>


<body>
    <div class="process-container">
        <!-- Page Header -->
        <div class="process-header">
            <h1 class="process-title">
                <i class="fas fa-folder-open"></i>
                Gerenciamento de Processos
            </h1>
            <div class="process-actions">
                <button onclick="loadAllProcesses()" class="btn btn--primary">
                    <i class="fas fa-sync-alt"></i>
                    Atualizar Lista
                </button>
                <button onclick="showSearchModal()" class="btn btn--secondary">
                    <i class="fas fa-search"></i>
                    Buscar Processo
                </button>
                <button onclick="orchestrateCase()" class="btn btn--primary">
                    <i class="fas fa-magic"></i>
                    Orquestrar Caso
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" 
                   placeholder="Digite o ID ou nome do processo para filtrar..." 
                   onkeyup="filterProcesses()">
        </div>

        <!-- Content Area -->
        <div class="process-content">
            <div id="processListContainer">
                <div class="status-loading">
                    <div><i class="fas fa-circle-notch"></i></div>
                    <div>Carregando processos...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="processSearchModal" class="modal">
        <div class="modal__content" onclick="event.stopPropagation()">
            <div class="modal__header">üîç Buscar Processo</div>
            <div class="info-text">Digite o ID do processo para ver o resumo completo:</div>
            <input type="text" id="processIdInput" class="modal__input" 
                   placeholder="Ex: PROC-001, UI-01" 
                   onkeypress="if(event.key==='Enter') searchProcess()">
            <div class="modal__buttons">
                <button class="modal__button modal__button--secondary" onclick="closeSearchModal()">Cancelar</button>
                <button class="modal__button modal__button--primary" onclick="searchProcess()">Buscar Resumo</button>
            </div>
        </div>
    </div>

    <!-- Process Details Modal -->
    <div id="processDetailsModal" class="modal">
        <div class="modal__content modal__content--large" onclick="event.stopPropagation()">
            <div class="modal__header modal__header--large">
                <h3 id="processDetailsTitle" class="modal__title">Detalhes do Processo</h3>
                <button class="modal__close" onclick="closeDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal__body">
                <div id="processDetailsContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const API_BASE_URL = window.location.protocol + '//' + window.location.host;
        let allProcesses = [];

        // Check authentication on load
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('Voc√™ precisa estar autenticado para acessar esta p√°gina.');
                window.close();
                return;
            }
            loadAllProcesses();
        });

        // API Helper
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('jwtToken');
            const headers = {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };

            try {
                const response = await fetch(API_BASE_URL + endpoint, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });

                const data = await response.json();
                return { ok: response.ok, status: response.status, data };
            } catch (error) {
                console.error('API Request failed:', error);
                return { ok: false, error: error.message };
            }
        }

        // Load all processes
        async function loadAllProcesses() {
            const container = document.getElementById('processListContainer');
            container.innerHTML = '<div class="status-loading"><div><i class="fas fa-circle-notch"></i></div><div>Carregando processos...</div></div>';

            try {
                // Get data from all services to find unique process IDs
                const [docsRes, deadlinesRes, hearingsRes] = await Promise.all([
                    apiRequest('/api/documents'),
                    apiRequest('/api/deadlines'),
                    apiRequest('/api/hearings')
                ]);

                const processMap = new Map();

                // Collect process IDs and creation dates from documents
                if (docsRes.ok && Array.isArray(docsRes.data)) {
                    docsRes.data.forEach(doc => {
                        if (doc.process_id) {
                            if (!processMap.has(doc.process_id)) {
                                processMap.set(doc.process_id, {
                                    id: doc.process_id,
                                    name: `Processo ${doc.process_id}`,
                                    created_at: doc.created_at || doc.timestamp || null
                                });
                            } else {
                                // Update if this document has an earlier date
                                const existing = processMap.get(doc.process_id);
                                const docDate = doc.created_at || doc.timestamp;
                                if (docDate && (!existing.created_at || new Date(docDate) < new Date(existing.created_at))) {
                                    existing.created_at = docDate;
                                }
                            }
                        }
                    });
                }

                // Collect process IDs from deadlines
                if (deadlinesRes.ok && Array.isArray(deadlinesRes.data)) {
                    deadlinesRes.data.forEach(deadline => {
                        if (deadline.process_id) {
                            if (!processMap.has(deadline.process_id)) {
                                processMap.set(deadline.process_id, {
                                    id: deadline.process_id,
                                    name: `Processo ${deadline.process_id}`,
                                    created_at: deadline.created_at || null
                                });
                            } else {
                                const existing = processMap.get(deadline.process_id);
                                const deadlineDate = deadline.created_at;
                                if (deadlineDate && (!existing.created_at || new Date(deadlineDate) < new Date(existing.created_at))) {
                                    existing.created_at = deadlineDate;
                                }
                            }
                        }
                    });
                }

                // Collect process IDs from hearings
                if (hearingsRes.ok) {
                    const hearings = hearingsRes.data.items || hearingsRes.data;
                    if (Array.isArray(hearings)) {
                        hearings.forEach(hearing => {
                            if (hearing.process_id) {
                                if (!processMap.has(hearing.process_id)) {
                                    processMap.set(hearing.process_id, {
                                        id: hearing.process_id,
                                        name: `Processo ${hearing.process_id}`,
                                        created_at: hearing.created_at || null
                                    });
                                } else {
                                    const existing = processMap.get(hearing.process_id);
                                    const hearingDate = hearing.created_at;
                                    if (hearingDate && (!existing.created_at || new Date(hearingDate) < new Date(existing.created_at))) {
                                        existing.created_at = hearingDate;
                                    }
                                }
                            }
                        });
                    }
                }

                allProcesses = Array.from(processMap.values());

                renderProcessTable(allProcesses);
            } catch (error) {
                console.error('Error loading processes:', error);
                container.innerHTML = '<div class="empty-state">Erro ao carregar processos.</div>';
            }
        }

        // Render process table
        function renderProcessTable(processes) {
            const container = document.getElementById('processListContainer');
            
            if (!processes || processes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state__icon"><i class="fas fa-folder-open"></i></div><div class="empty-state__title">Nenhum processo encontrado</div><div class="empty-state__text">Comece criando documentos, prazos ou audi√™ncias vinculados a processos.</div></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table">';
            html += '<thead><tr><th>ID do Processo</th><th>Nome</th><th>Criado em</th><th>A√ß√µes</th></tr></thead>';
            html += '<tbody>';

            processes.forEach(process => {
                const createdDate = process.created_at ? formatDate(process.created_at) : '<span style="color: #94a3b8;">Data n√£o dispon√≠vel</span>';
                html += `<tr>
                    <td><strong>${escapeHtml(process.id)}</strong></td>
                    <td>${escapeHtml(process.name)}</td>
                    <td class="col-date">${createdDate}</td>
                    <td>
                        <button onclick="viewProcessDetails('${escapeHtml(process.id)}')" class="btn btn--secondary" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-eye"></i> Ver Detalhes
                        </button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Filter processes
        function filterProcesses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProcesses.filter(p => 
                p.id.toLowerCase().includes(searchTerm) || 
                p.name.toLowerCase().includes(searchTerm)
            );
            renderProcessTable(filtered);
        }

        // View process details
        async function viewProcessDetails(processId) {
            try {
                const response = await apiRequest(`/api/process/${processId}/summary`);
                
                if (response.ok) {
                    showProcessDetailsModal(processId, response.data);
                } else {
                    alert(`Erro ao buscar detalhes do processo: ${response.data.error || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Error viewing process details:', error);
                alert('Erro ao buscar detalhes do processo.');
            }
        }

        // Show process details in a nice modal
        function showProcessDetailsModal(processId, data) {
            const modal = document.getElementById('processDetailsModal');
            const title = document.getElementById('processDetailsTitle');
            const content = document.getElementById('processDetailsContent');

            title.innerHTML = `<i class="fas fa-folder-open"></i> Detalhes do Processo ${escapeHtml(processId)}`;

            let html = '<div style="display: grid; gap: 2rem;">';

            // Documents Section
            if (data.documents && data.documents.length > 0) {
                html += '<div class="details-section">';
                html += '<h3 class="section-title"><i class="fas fa-file-alt"></i> Documentos</h3>';
                html += '<div class="details-grid">';
                data.documents.forEach((doc, index) => {
                    html += `<div class="detail-card">
                        <div class="detail-card-header">
                            <span class="detail-card-number">#${index + 1}</span>
                            <span class="detail-card-id">${escapeHtml(doc.id || 'N/A')}</span>
                        </div>
                        <div class="detail-card-body">
                            <div class="detail-row">
                                <span class="detail-label">T√≠tulo:</span>
                                <span class="detail-value">${escapeHtml(doc.title || 'N/A')}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Autor:</span>
                                <span class="detail-value">${escapeHtml(doc.author || 'N/A')}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Criado em:</span>
                                <span class="detail-value col-date">${doc.created_at ? formatDate(doc.created_at) : 'N/A'}</span>
                            </div>
                            ${doc.content ? `<div class="detail-row detail-row-full">
                                <span class="detail-label">Conte√∫do:</span>
                                <span class="detail-value detail-content">${escapeHtml(doc.content)}</span>
                            </div>` : ''}
                        </div>
                    </div>`;
                });
                html += '</div></div>';
            }

            // Deadlines Section
            if (data.deadlines && data.deadlines.length > 0) {
                html += '<div class="details-section">';
                html += '<h3 class="section-title"><i class="fas fa-clock"></i> Prazos</h3>';
                html += '<div class="details-grid">';
                data.deadlines.forEach((deadline, index) => {
                    html += `<div class="detail-card">
                        <div class="detail-card-header">
                            <span class="detail-card-number">#${index + 1}</span>
                            <span class="detail-card-id">${escapeHtml(deadline.id || 'N/A')}</span>
                        </div>
                        <div class="detail-card-body">
                            <div class="detail-row">
                                <span class="detail-label">Vencimento:</span>
                                <span class="detail-value col-date">${deadline.due_date ? formatDate(deadline.due_date) : 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Criado em:</span>
                                <span class="detail-value col-date">${deadline.created_at ? formatDate(deadline.created_at) : 'N/A'}</span>
                            </div>
                            ${deadline.description ? `<div class="detail-row detail-row-full">
                                <span class="detail-label">Descri√ß√£o:</span>
                                <span class="detail-value">${escapeHtml(deadline.description)}</span>
                            </div>` : ''}
                        </div>
                    </div>`;
                });
                html += '</div></div>';
            }

            // Hearings Section
            if (data.hearings && data.hearings.length > 0) {
                html += '<div class="details-section">';
                html += '<h3 class="section-title"><i class="fas fa-gavel"></i> Audi√™ncias</h3>';
                html += '<div class="details-grid">';
                data.hearings.forEach((hearing, index) => {
                    html += `<div class="detail-card">
                        <div class="detail-card-header">
                            <span class="detail-card-number">#${index + 1}</span>
                            <span class="detail-card-id">${escapeHtml(hearing.id || 'N/A')}</span>
                        </div>
                        <div class="detail-card-body">
                            <div class="detail-row">
                                <span class="detail-label">Data:</span>
                                <span class="detail-value col-date">${hearing.date ? formatDate(hearing.date) : 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Sala:</span>
                                <span class="detail-value">${escapeHtml(hearing.courtroom || 'N/A')}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Criado em:</span>
                                <span class="detail-value col-date">${hearing.created_at ? formatDate(hearing.created_at) : 'N/A'}</span>
                            </div>
                            ${hearing.description ? `<div class="detail-row detail-row-full">
                                <span class="detail-label">Descri√ß√£o:</span>
                                <span class="detail-value">${escapeHtml(hearing.description)}</span>
                            </div>` : ''}
                        </div>
                    </div>`;
                });
                html += '</div></div>';
            }

            // Empty state
            if ((!data.documents || data.documents.length === 0) && 
                (!data.deadlines || data.deadlines.length === 0) && 
                (!data.hearings || data.hearings.length === 0)) {
                html += '<div class="empty-state">';
                html += '<div class="empty-state__icon"><i class="fas fa-inbox"></i></div>';
                html += '<div class="empty-state__title">Nenhum dado encontrado</div>';
                html += '<div class="empty-state__text">Este processo n√£o possui documentos, prazos ou audi√™ncias associados.</div>';
                html += '</div>';
            }

            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'flex';
        }

        // Close details modal
        function closeDetailsModal() {
            const modal = document.getElementById('processDetailsModal');
            modal.style.display = 'none';
        }

        // Show search modal
        function showSearchModal() {
            const modal = document.getElementById('processSearchModal');
            modal.style.display = 'flex';
            document.getElementById('processIdInput').focus();
        }

        // Close search modal
        function closeSearchModal() {
            const modal = document.getElementById('processSearchModal');
            modal.style.display = 'none';
            document.getElementById('processIdInput').value = '';
        }

        // Search process
        async function searchProcess() {
            const processId = document.getElementById('processIdInput').value.trim();
            closeSearchModal();
            
            if (!processId) {
                alert('Por favor, informe o ID do processo.');
                return;
            }

            await viewProcessDetails(processId);
        }

        // Orchestrate case
        async function orchestrateCase() {
            if (!confirm('Deseja criar um novo caso orquestrado? Isso criar√° automaticamente um documento, prazo e audi√™ncia para o processo ORCH-01.')) {
                return;
            }

            const today = new Date();
            const deadlineDate = new Date(today);
            deadlineDate.setDate(today.getDate() + 30);
            const hearingDate = new Date(today);
            hearingDate.setDate(today.getDate() + 15);

            const orchestrationData = {
                document: {
                    title: 'Peti√ß√£o Inicial via Orquestra√ß√£o',
                    content: 'Documento criado atrav√©s da funcionalidade de orquestra√ß√£o autom√°tica.',
                    author: 'Sistema'
                },
                deadline: {
                    process_id: 'ORCH-01',
                    due_date: deadlineDate.toISOString().split('T')[0],
                    description: 'Prazo para resposta - criado via orquestra√ß√£o'
                },
                hearing: {
                    process_id: 'ORCH-01',
                    date: hearingDate.toISOString().split('T')[0],
                    courtroom: 'Sala 3',
                    description: 'Audi√™ncia inicial - criada via orquestra√ß√£o'
                }
            };

            try {
                const response = await apiRequest('/api/orchestrate/file-case', {
                    method: 'POST',
                    body: JSON.stringify(orchestrationData)
                });

                if (response.ok) {
                    alert('Caso orquestrado com sucesso! Atualizando lista...');
                    loadAllProcesses();
                } else {
                    alert(`Erro ao orquestrar caso: ${response.data.error || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Error orchestrating case:', error);
                alert('Erro ao orquestrar caso.');
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                return dateString;
            }
        }

        // Close modal when clicking outside
        document.getElementById('processSearchModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSearchModal();
            }
        });

        // Close details modal when clicking outside
        document.getElementById('processDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetailsModal();
            }
        });
    </script>
</body>

</html>
<script>
        async function loadHeader() {
            try {
                const response = await fetch('header.html');
                const html = await response.text();
                document.getElementById('header-placeholder').innerHTML = html;
            } catch (error) {
                console.error('Error loading header:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', async function() {
            await loadHeader();
            
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('Voc√™ precisa estar autenticado para acessar esta p√°gina.');
                window.close();
                return;
            }
            loadAllProcesses();
        });
    </script>